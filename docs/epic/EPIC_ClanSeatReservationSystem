# ğŸ“˜ EPIC: Clan Seat Reservation System (`!reserve <clantag>`)

## 0. Purpose & Scope

Recruiters need a reliable way to temporarily **hold a clan seat** for a recruit while the placement process is ongoing.
This EPIC introduces the `!reserve <clantag>` command, a structured sheet-backed reservation ledger, scheduled reminders & auto-release, and updated availability logic across the cluster.

Reservations must:

* Live in a dedicated **Reservations ledger** in Google Sheets
* Respect **ingame open spots (col E)**
* Adjust **effective availability (AF)**
* Maintain **reserved count (AH)**
* Maintain **reserved summary (AI)**
* Gracefully inform recruiters & threads
* Be fully controlled by a **feature toggle**
* Require **Recruiter or Admin roles**
* Update the **in-memory bot_info cache** instantly (Option A)

This EPIC defines the behaviour, data model, command flow, error handling, and scheduled tasks.

---

# 1. Permissions, Roles & Toggles

## 1.1 Feature Toggle

In Recruitment Sheet â€º Config:

* `FEATURE_RESERVATIONS` â†’ `TRUE` / `FALSE`

If `FALSE`:

* All reservation commands politely refuse and do nothing.

If `TRUE`:

* Full functionality is active.

## 1.2 Who Can Use Reservation Features

A user is allowed if **any** of these is true:

* Has a role in `ADMIN_ROLE_IDS`
* Has a role in `RECRUITER_ROLE_IDS`

Everyone else:

* If they attempt `!reserve` â†’

  > â€œOnly Recruiters (or Admins) can reserve clan spots.â€

## 1.3 Where Commands Are Allowed

`!reserve <clantag>` is only valid **inside a recruitâ€™s ticket thread**.

If invoked elsewhere:

> â€œPlease run `!reserve` inside the recruitâ€™s ticket thread so I know who you mean.â€

---

# 2. Sheets Structure & Data Semantics

## 2.1 CLANS_TAB (`bot_info`)

Columns relevant to this EPIC:

| Column | Meaning              | Edited by      |
| ------ | -------------------- | -------------- |
| **E**  | Ingame open spots    | Human (SSoT)   |
| **AF** | Effective open spots | Bot (computed) |
| **AG** | Inactives            | Unchanged      |
| **AH** | Reserved count       | Bot (computed) |
| **AI** | Reserved summary     | Bot (computed) |

### 2.1.1 Final Availability Math

Let:

* `E` = ingame open spots (manual, col E)
* `R` = count of **active** reservations for that clan

The bot maintains:

* **AH** = `R`
* **AF** = `max(E - R, 0)`
* **AI** = `"<R> -> username1, username2, â€¦"`

**Only E is edited by humans.**
All other values (AF/AH/AI) are rewritten by the bot.

AF continues to be the **SSoT for all panels & reports**.

## 2.2 RESERVATIONS_TAB

Configured in Config as `RESERVATIONS_TAB`.

Required columns:

| Col | Name           | Type              |
| --- | -------------- | ----------------- |
| A   | thread_id      | string            |
| B   | ticket_user_id | Discord ID        |
| C   | recruiter_id   | Discord ID        |
| D   | clan_tag       | string            |
| E   | reserved_until | date (YYYY-MM-DD) |
| F   | created_at     | UTC ISO           |
| G   | status         | string            |
| H   | notes          | text              |

### 2.2.1 Status Values

* `active`
* `released` (future manual feature)
* `expired` (auto-release job)
* `cancelled` (optional; not required in v1)

Only `active` rows count toward `R`.

### 2.2.2 Active Reservation Definition

A row is considered **active** if:

* `status == "active"`

(We do **not** auto-expire by date alone; the auto-release job changes the status.)

### 2.2.3 Summary Name Resolution (for column AI)

When building AI:

* For each active reservation in a clan, resolve `ticket_user_id` â†’ display name.
* If resolution fails, use `unknown:<ID>`.
* AI = `"<R> -> name1, name2, â€¦"`
* If `R == 0`: AI is `""`.

---

# 3. Command Flow â€” `!reserve <clantag>`

Usage:

```
!reserve C1CE
```

## 3.1 Preconditions

1. `FEATURE_RESERVATIONS` must be TRUE
2. User must be Admin or Recruiter
3. Command must be inside ticket thread
4. `clantag` must exist in `CLANS_TAB`

If any fail â†’ polite error + stop.

---

## 3.2 Dialogue Steps

### Step 1 â€” Ask â€œWho?â€

Bot:

> â€œWho do you want to reserve a spot for in `<clantag>`?
> You can @mention them or paste their Discord ID.â€

* Accepts @mention or raw ID
* Validates it resolves to a user
* If invalid: repeat
* If `cancel`: abort workflow

### Step 2 â€” Ask â€œUntil which date?â€

Bot:

> â€œUntil which date? Please use `YYYY-MM-DD` (no time).â€

Validation:

* Must be a valid date
* Must be today or later
* If invalid: ask again

### Step 3 â€” Compute Effective Availability

Bot reads:

* `E` (col E)
* `R` (active reservations count)

Compute:

```
effective_available = max(E - R, 0)
```

Case 1: `> 0`
â†’ continue normally

Case 2: `== 0`
â†’ warn + require reason:

> â€œThere are currently no effective open spots in `<clantag>`.
> You can still reserve. Please provide a reason.â€

Store reason in `notes`.

### Step 4 â€” Confirmation

Bot displays:

> â€œReserve **1 spot** in `<clantag>` for `<@user>` until **<date>**.
> Type `yes` to save, `no` to cancel, `change` to edit.â€

### Step 5 â€” Action Branches

#### If `no`

â†’ end, no sheet writes

#### If `change`

â†’ â€œWhat do you want to change: `user` or `date`?â€
â†’ loop back appropriately

#### If `yes` â†’ **Perform reservation**

1. Append new row to `RESERVATIONS_TAB`:

   * `thread_id`
   * `ticket_user_id`
   * `recruiter_id`
   * `clan_tag`
   * `reserved_until`
   * `created_at` (UTC ISO)
   * `status = active`
   * `notes` (if any)

2. Recompute `R` for that clan

3. Write to `CLANS_TAB`:

   * `AH = R`
   * `AF = max(E - R, 0)`
   * `AI = "<R> -> usernames"`

4. **Update in-memory bot_info cache entry for this clan**
   (same AH/AF/AI values)

5. Respond:

> â€œReserved 1 spot in `<clantag>` for `<@user>` until **<date>**.
> Reserved: `<AH>`. Effective open spots: `<AF>`.â€

### Error handling

If any sheet write fails:

* Do **not** update cache
* Do **not** leave partial state
* Bot posts:

> â€œError saving reservation. Nothing was changed. Please try again or poke an admin.â€

---

# 4. Reserved With 0 Spots Scenario

If `effective_available == 0` at reservation time:

* Bot asks for a reason
* Reservation **still allowed**
* Reason stored in `notes`
* Resulting AF becomes `max(E - R, 0)` â†’ typically 0

---

# 5. Scheduled Reservation Tasks

Use existing scheduling approach (â‰¤3/day allowed).

## 5.1 Reminder Job â€” **12:00 UTC**

For each row where:

* `status == active`
* `reserved_until == today`

Actions:

1. Post reminder in ticket thread:

> â€œReminder: the reserved spot in `<clantag>` for `<@user>` ends today.
> Please extend if needed, otherwise Iâ€™ll release the seat later today.â€

2. Tag recruiter roles
3. Recompute AF/AH/AI for this clan (optional but safe)

No status change yet.
This begins the **6-hour grace period**.

---

## 5.2 Auto-Release Job â€” **18:00 UTC**

For each row where:

* `status == active`
* `reserved_until <= today`

Actions:

1. Set status â†’ `expired`
2. Recompute R for the clan
3. Write new:

   * `AH = R`
   * `AF = max(E - R, 0)`
   * `AI = "<R> -> usernames"`
4. Update in-memory cache entry for this clan
5. Post in thread:

> â€œThe reserved spot in `<clantag>` for `<@user>` has expired and the seat has been released.â€

6. Post summary to `RECRUITERS_THREAD_ID`:

> â€œâš ï¸ Reservation expired â€” clan=`<clantag>` â€¢ user=`<@user>` â€¢ until=`<date>` â€¢ released at 18:00 UTC.â€

If thread missing, skip but log in recruiters thread with a note.

---

# 6. Future Extensions (Backlog)

Not required in v1 but compatible with this model:

* `!reservations` â€” list reservations in this thread
* `!reservations <clan>` â€” list clanâ€™s active reservations
* `!reserve release` â€” manual release in thread
* `!reserve extend <YYYY-MM-DD>` â€” extend date
* Maintenance: `!reserve rebuild` to recompute AF/AH/AI for all clans

---

# 7. Cache Behaviour (Final)

To ensure panels always show current data with minimal quota usage:

**On every reservation state change:**

* After writing updated AH/AF/AI to `CLANS_TAB`,
  the bot **immediately updates the in-memory cache entry** for that clan
  using the same AH/AF/AI values.

This ensures:

* Recruiter panel immediately reflects new seat counts
* No global cache clears
* No dependency on scheduled refreshes
* Minimal performance impact

If sheet write failed â†’ do **not** update cache.

---

# 8. Summary

This EPIC introduces:

* A recruiter/admin-only `!reserve` flow
* A proper sheet-based reservation ledger
* Stable availability math respecting ingame data
* Daily reminder & auto-release
* Full consistency with all existing panels via local cache updates
* Clean separation of human SSoT (E) and bot-maintained fields (AF/AH/AI)

Doc last updated: 2025-11-13 (v0.9.7)
