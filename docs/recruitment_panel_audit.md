# Recruitment Panel Feature Audit

## A. Feature Catalog (UI-only)
| Repo | Feature | Surfaces & Flow | Data Touchpoints | Channels / Threads | Permissions & Triggers |
| --- | --- | --- | --- | --- | --- |
| Unified | Recruiter Panel | Not implemented. `recruitment.search.setup` only calls the placeholder loader and registers no commands or views.【F:recruitment/search.py†L1-L40】【F:recruitment/__init__.py†L1-L10】 | n/a | n/a | n/a |
| Unified | Member Panel | Same as above; there is no user-facing surface yet.【F:recruitment/search.py†L1-L40】 | n/a | n/a | n/a |
| Legacy MM | Recruiter Panel | Prefix command `!clanmatch` (2s cooldown) spawns `ClanMatchView` (4 dropdowns + CvC/Siege/roster toggles, reset, and Search button). Only opener can interact; Search button queries Sheets and paginates results with `PagedResultsView`. Panel refreshes in place when filters change.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1708-L1807】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1161-L1520】 | Reads Google Sheet via `get_rows`, filtering columns A–AF for roster and filter metadata. No writes.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L136-L155】【F:AUDIT/20251010_src/MM/README.md†L54-L78】 | Posts to invoking channel or fixed recruiter thread per `PANEL_THREAD_MODE`; pings opener when panel is created in the fixed thread.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1678-L1776】 | Requires recruiter/admin roles via `_allowed_recruiter`; command gated at prefix and via interaction checks. Cooldown 1 use / 2s per user.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1122-L1140】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1708-L1718】 |
| Legacy MM | Member Panel | Prefix command `!clansearch` (2s cooldown) spawns `ClanMatchView` in `search` mode with same filters. Search returns paginated embeds with attachments and view-mode buttons (Lite/Entry/Profile) via `MemberSearchPagedView` and per-result `SearchResultFlipView`. Owner-only interactions; duplicate summons edit existing panel.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1806-L1847】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L840-L1013】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1472-L1510】 | Same read-only Sheet filters/columns as recruiter panel.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L136-L155】【F:AUDIT/20251010_src/MM/README.md†L54-L74】 | Always replies in the invoking channel; results reuse original message when reopened.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1832-L1847】 | Open to all users; interaction check rejects non-owners with guidance to open their own panel. Cooldown 1 use / 2s per user.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1806-L1818】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1309-L1318】 |
| Legacy WC | Recruiter Panel | Absent — WelcomeCrew focuses on thread watchers and logging; no recruitment panel commands are documented or implemented.【F:AUDIT/20251010_src/WC/README.md†L1-L80】 | n/a | n/a | n/a |
| Legacy WC | Member Panel | Absent for the same reason; WelcomeCrew provides watcher utilities only.【F:AUDIT/20251010_src/WC/README.md†L1-L80】 | n/a | n/a | n/a |

## B. Proposed Unified Modules (toggleable)
| Module Key | Purpose | Files to Own | Commands / Events | Permissions | Data Dependencies | Logging Surface |
| --- | --- | --- | --- | --- | --- | --- |
| `recruiter_panel` | Discord prefix workflow for staff to filter clans and handoff recruits, matching the legacy `!clanmatch` UX.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1708-L1776】 | `recruitment/search.py`, new recruiter panel module under `recruitment/` reusing shared views/helpers. | `!clanmatch`, dropdown interactions, paginator updates, roster toggle refresh.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1322-L1509】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1708-L1776】 | Recruiter/admin roles using `shared.coreops_rbac.is_recruiter` + admin fallback.【F:recruitment/search.py†L12-L22】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1122-L1140】 | Recruitment sheet `bot_info` tab columns A–AF; requires clan filter columns and inactives counts.【F:AUDIT/20251010_src/MM/README.md†L54-L74】 | Currently prints to stdout for thread routing; should emit structured log via `Runtime.send_log_message` when spawning panels.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1748-L1774】【F:shared/runtime.py†L564-L585】 |
| `member_panel` | Member-facing browsing flow mirroring legacy `!clansearch`, including multi-view embeds and attachments.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1806-L1847】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L840-L1013】 | `recruitment/search.py`, shared embed/view helpers for lite/profile/entry renders. | `!clansearch`, MemberSearchPagedView pagination, SearchResultFlipView buttons.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L840-L1013】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1472-L1510】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1806-L1847】 | Open to all; maintain owner-lock checks to block others from interacting.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1309-L1318】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1806-L1818】 | Same recruitment sheet tab/columns as recruiter panel, plus emoji assets for thumbnails.【F:AUDIT/20251010_src/MM/README.md†L54-L74】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1487-L1499】 | No dedicated logging today; add optional log for search invocations via shared runtime log channel.【F:shared/runtime.py†L564-L585】 |
| `recruitment_welcome` | Existing welcome bridge command using cached templates; keep toggle compatibility with panel modules.【F:recruitment/welcome.py†L12-L63】 | `recruitment/welcome.py` | `!welcome` prefix command (staff tier).【F:recruitment/welcome.py†L24-L44】 | Staff/admin via shared RBAC helper.【F:recruitment/welcome.py†L12-L41】 | Recruitment sheet `WelcomeTemplates` tab columns (`ClanTag`, `Message`, etc.).【F:recruitment/welcome.py†L32-L43】【F:AUDIT/20251010_src/MM/README.md†L80-L110】 | Sends structured welcome log via runtime helper; keep when panels toggled off.【F:recruitment/welcome.py†L56-L63】 |

## C. Dependency Map
| Module Key | Required Platform Services | Init Order Notes | Leaky Boundaries |
| --- | --- | --- | --- |
| `recruiter_panel` | RBAC (role lookups), Sheets cache (`sheets.recruitment.fetch_clans`), emoji assets for thumbnails, runtime scheduler only for global cache warmers already registered in `shared.runtime`.| Needs Sheets cache ready before command registration; relies on cache registration triggered during module import. If disabled, ensure cache warmers still register via `sheets.recruitment` import from other modules.【F:shared/runtime.py†L564-L599】【F:sheets/recruitment.py†L1-L94】 | Legacy logic stores state in module globals (`ACTIVE_PANELS`, config constants) and prints to stdout; toggling requires ensuring those globals reset when module disabled.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1152-L1175】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1748-L1774】 |
| `member_panel` | Sheets cache (same as recruiter), emoji helper for attachments, Discord file uploads; no scheduler use. | Should initialize after Sheets cache registration; otherwise first search hits live Sheets synchronously (legacy behavior).【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1428-L1499】 | Shares `ClanMatchView` class with recruiter panel, coupling embed variants; toggling one but not the other requires refactoring view instantiation to avoid unused buttons.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1161-L1510】 |
| `recruitment_welcome` | RBAC, Sheets cache bucket `templates`, runtime log channel.【F:recruitment/welcome.py†L24-L63】【F:sheets/recruitment.py†L95-L146】 | Must stay loadable even if panels disabled so welcome command works; relies on cached templates bucket registration at import time.【F:sheets/recruitment.py†L118-L146】 | Shares module-level cache with other recruitment features; cache registration occurs on import, so toggling commands cannot skip module import without moving registration.【F:sheets/recruitment.py†L118-L146】 |

## D. Overlap Matrix (legacy ↔ unified)
| Feature | MM | WC | Unified |
| --- | --- | --- | --- |
| Recruiter Panel | Present — fully implemented `!clanmatch` panel with filters, pagination, and recruiter gating.【F:AUDIT/20251010_src/MM/README.md†L16-L35】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1708-L1776】 | Absent — WelcomeCrew ships watcher utilities only, no panels.【F:AUDIT/20251010_src/WC/README.md†L1-L80】 | Absent — unified loader stubs recruitment search without registering commands.【F:recruitment/search.py†L1-L40】 |
| Member Panel | Present — `!clansearch` owner-locked browsing flow with multi-view embeds.【F:AUDIT/20251010_src/MM/README.md†L16-L35】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1806-L1847】 | Absent — no member panel features documented or implemented.【F:AUDIT/20251010_src/WC/README.md†L1-L80】 | Absent — no commands registered in unified search module.【F:recruitment/search.py†L1-L40】 |

## E. Minimal Hook Points
- `shared/runtime.py` lines 564-579: wrap each `await recruitment_*.setup` call with `if is_enabled(module_key)` to gate command registration during startup.【F:shared/runtime.py†L564-L585】  Ensure `coreops` still loads first because it provides RBAC helpers needed by gated modules.
- `recruitment/search.py` line 38: guard the future panel registration logic inside `setup` before calling into `ensure_loaded` or adding commands.【F:recruitment/search.py†L38-L40】  Placeholder loader currently no-ops, so gating here is safe.
- `recruitment/welcome.py` line 64 (`setup`): if the welcome module stays independent, leave it ungated unless a separate toggle controls `recruitment_welcome`; only skip `add_cog` when module disabled but keep import-time cache registration active.【F:recruitment/welcome.py†L24-L64】【F:sheets/recruitment.py†L118-L146】
- Future panel helpers (once ported) should isolate global state in module-level `setup` functions so `ClanMatchView`/`MemberSearchPagedView` definitions do not execute heavy logic at import time; in legacy code, view classes depend on module globals such as `ACTIVE_PANELS` and should be instantiated lazily to avoid side effects when disabled.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1152-L1510】  Keep any emoji cache warmers or Sheets registrations outside these gates if other modules still rely on them.

## F. Risks & Constraints
- Hard-coded panel thread routing constants (`PANEL_THREAD_MODE`, `PANEL_FIXED_THREAD_ID`) live in legacy environment parsing; unified config exposes getters but without panel wiring yet. Missing or misconfigured IDs will break recruiter panel delivery unless error handling remains (legacy returns `None`).【F:shared/config.py†L491-L498】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1678-L1750】
- Owner-lock enforcement depends on per-user message tracking (`ACTIVE_PANELS`). If toggles unload the module without cleaning this map, stale message IDs could leak interactions when re-enabled.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1152-L1175】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1309-L1318】
- Search rendering assumes Sheet columns match legacy schema; missing headers or reorganized tabs will lead to empty result sets or index errors. Unified implementation must validate Config tab entries before enabling panels.【F:AUDIT/20251010_src/MM/README.md†L54-L78】【F:sheets/recruitment.py†L29-L66】
- Legacy code uses synchronous Sheet reads on the gateway thread (`get_rows`); without async cache integration, unified panels risk blocking interactions under high latency.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L136-L155】【F:AUDIT/20251010_codex_audit_MM_WC/FINDINGS.md†L25-L30】
- Thumbnail attachments rely on server emoji availability; missing emojis degrade panel visuals and should be handled gracefully when porting.【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1487-L1499】

## G. Open Questions
1. How should the unified bot expose legacy panel state (e.g., `ACTIVE_PANELS`) so that multiple guilds can run concurrent panels without collisions once modules become toggleable?【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1152-L1175】
2. Should recruiter panel thread routing continue to allow the legacy `fixed` thread mode, or can unified deployments rely solely on per-channel panels to simplify configuration?【F:shared/config.py†L491-L498】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L1678-L1750】
