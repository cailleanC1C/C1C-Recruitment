# Command System Guide — v0.9.3-phase3b-rc4

C1C Recruitment's command tree now runs on a unified prefix, dynamic help rendering, and
explicit tier declarations introduced across Phase 3b. This guide captures the current
state for internal developers and operators. See the
[CoreOps contract](coreops_contract.md) for command execution responsibilities and
escalation paths.

## Command System Overview

- Every command resolves from a single prefix: `!` or a direct mention of the bot
  (`@C1C Recruitment`).
- Plain commands (e.g. `!help`, `!ping`, `!health`, `!env`) are **admin-only** entry
  points that route to the same handlers as their grouped counterparts.
- Grouped commands under `!rec …` are exposed to members according to the tier declared on
  each handler.
- The help renderer inspects tier metadata to list commands in **User**, **Recruiter / Staff**,
  and **Admin** sections. Members only see the sections they qualify for.
- Each command declares its tier via the `@tier("...")` decorator from
  `shared.coreops.helpers.tiers`.

| Tier | Example Commands | Who Can Run | Notes |
|------|------------------|--------------|-------|
| **User** | `!rec help`, `!rec ping`, `!clansearch`, `!clan <tag>` | All members | Public info |
| **Staff** | `!rec config`, `!rec digest`, `!rec refresh clansinfo`, `!welcome`, `!clanmatch` | Recruiters / Staff | Uses staff RBAC |
| **Admin** | `!help`, `!env`, `!reload`, `!checksheet`, `!rec refresh all`, `!health` | Cluster Admins | Admin-only tools |

## RBAC and Gating Rules

> See also the [CoreOps contract](coreops_contract.md#rbac-and-incident-handling) for
> operational requirements.

- The legacy `manage_guild` permission bypass is removed. Only explicit helper checks
  determine access.
- Use the shared helpers `is_admin_member()` and `is_staff_member()` from
  `shared.coreops.helpers.tiers` and companion RBAC modules.
- Decorators such as `@ops_only("admin")` and `@ops_only("staff")` wrap these helpers and
  perform the same checks for grouped commands.
- RBAC gating governs command execution only. Generating help output uses side-effect-free
  boolean permission probes.
- Deny messages ("Admin only.", "Staff only.") appear only when a member executes a
  command without the required tier. Help listings always render silently for
  non-qualified commands.

## Help System Behavior

- `!rec help` renders the user or staff view depending on the member's tier.
- `!help` renders the admin view and is only callable by admins.
- Help output is grouped into three sections: **User**, **Recruiter/Staff**, and
  **Admin**.
- The list of commands is auto-generated by scanning the command tree at runtime and
  reading each command's `tier` metadata. Tiers default to `admin`; every public command
  must declare an explicit tier to appear for lower roles.
- Commands can opt out of help by setting `cmd.extras["hide_in_help"] = True`.
- The help renderer ignores `hidden=True` flags except for untiered internal commands.
- Approved embed copy:

  **Description:**

  ```text
  C1C-Recruitment keeps the doors open and the hearths warm.
  It’s how we find new clanmates, help old friends move up, and keep every hall filled with good company.
  Members can peek at which clans have room, check what’s needed to join, or dig into details about any clan across the cluster.
  Recruiters use it to spot open slots, match new arrivals, and drop welcome notes so nobody gets lost on day one.
  All handled right here on Discord — fast, friendly, and stitched together with that usual C1C chaos and care.
  ```

  **Usage:**

  ```text
  For detailed info about a specific command, type it like this:
  !rec help rec ping  → shows info for !rec ping
  ```

## Adding New Commands (Internal Guide)

1. **Define the command**
   ```python
   @rec.command(name="example")
   async def example(ctx):
       ...
   ```
2. **Apply the tier decorator**
   ```python
   from shared.coreops.helpers.tiers import tier

   @tier("staff")  # or "user" / "admin"
   ```
3. **Gate with existing RBAC helpers**
   - Use only `is_admin_member()` and `is_staff_member()`.
   - Never rely on `manage_guild` or manual permission flags.
4. **Optional:** hide from help
   ```python
   cmd.extras["hide_in_help"] = True
   ```
5. **Run the tier audit**
   ```python
   from shared.coreops.helpers.tiers import rehydrate_tiers, audit_tiers

   rehydrate_tiers(bot)
   audit_tiers(bot, log)
   ```
   Expect no missing tiers.
6. **Validate help output**
   - `!rec help` as user → user commands only
   - `!rec help` as staff → user + staff
   - `!help` as admin → all commands
7. **PR metadata (required in every PR body)**
   ```
   [meta]
   labels: commands, comp:ops-contract, devx
   milestone: Harmonize v1.0
   [/meta]
   ```

## Known Command Sets (Phase 3 state)

The following tables mirror the authoritative Commands sheet for Phase 3.

### User tier

| Command | Purpose |
|---------|---------|
| `!rec help` | Lists accessible commands for the caller.
| `!rec ping` | Latency check surfaced in help for all members.
| `!clansearch` | Public recruiter intake search panel.
| `!clan <tag>` | Quick clan profile card.

### Recruiter / Staff tier

| Command | Purpose |
|---------|---------|
| `!clanmatch` | Recruiter panel with filters and paging for prospects.
| `!rec config` | Echoes config state for sanity checks (no secrets).
| `!rec digest` | Sends the daily digest summary on demand.
| `!rec refresh clansinfo` | Refreshes the clans cache when the guard window expires.
| `!welcome` | Posts a templated welcome message for placements.

### Admin tier

| Command | Purpose |
|---------|---------|
| `!help` | Admin-only help view with all tiers.
| `!ping` / `!health` | Plain shortcuts for uptime checks.
| `!rec refresh all` | Warms every Sheets cache bucket asynchronously.
| `!checksheet` | Validates that required Sheets tabs are present.
| `!env` | Dumps current environment configuration with masking.
| `!reload` | Hot-reloads command extensions without restarting the container.

## Help Copy Style

Use the approved copy when updating embeds or help output (see
[#help-system-behavior](#help-system-behavior)):

- **Description**

  ```text
  C1C-Recruitment keeps the doors open and the hearths warm.
  It’s how we find new clanmates, help old friends move up, and keep every hall filled with good company.
  Members can peek at which clans have room, check what’s needed to join, or dig into details about any clan across the cluster.
  Recruiters use it to spot open slots, match new arrivals, and drop welcome notes so nobody gets lost on day one.
  All handled right here on Discord — fast, friendly, and stitched together with that usual C1C chaos and care.
  ```

- **Usage**

  ```text
  To learn what a command does, type it like this:
  !rec help rec ping → shows info for !rec ping
  ```

---

_Doc last updated: 2025-10-17 (v0.9.3-phase3b-rc4)_
