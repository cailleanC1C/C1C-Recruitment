# Gateway Keepalive & Watchdog Comparison

| Aspect | Matchmaker (MM) | WelcomeCrew (WC) |
| --- | --- | --- |
| **Gateway instrumentation** | `on_socket_response` calls `_mark_event()`; `on_connect`/`on_resumed` flip `BOT_CONNECTED=True` and `_mark_event()`; `on_ready` records `_LAST_READY_TS`, marks event, and idempotently starts `_watchdog`, scheduled cleanup, and refresh tasks; `on_disconnect` flags `BOT_CONNECTED=False` and records `_LAST_DISCONNECT_TS`. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2161-L2254】 | Same event coverage (`on_socket_response`, `on_connect`, `on_resumed`, `on_ready`, `on_disconnect`) with identical state flips and `_watchdog` start. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1397-L1437】 |
| **Keepalive state tracked** | Globals: `BOT_CONNECTED`, `_LAST_READY_TS`, `_LAST_DISCONNECT_TS`, `_LAST_EVENT_TS`; `_mark_event()` timestamps gateway traffic. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2130-L2140】【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2256-L2276】 | Same globals and `_mark_event()` helper. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L662-L702】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1397-L1455】 |
| **Watchdog cadence** | `@tasks.loop(seconds=WATCHDOG_CHECK_SEC)` with env default 60 s. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2258-L2274】 | Identical 60 s loop via `WATCHDOG_CHECK_SEC`. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L696-L1450】 |
| **Zombie detection** | If connected and no events for >600 s with latency missing or >10 s, restart via `_maybe_restart("zombie…")`. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2275-L2286】 | Same 600 s + latency>10 guard; message text slightly different but behavior matches. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1452-L1461】 |
| **Disconnect watchdog** | If disconnected for >`WATCHDOG_MAX_DISCONNECT_SEC` (default 600 s) trigger restart. Tracks first observed disconnect time. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2288-L2297】 | Same threshold/logic. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1464-L1471】 |
| **Restart action** | `_maybe_restart` logs warning, awaits `bot.close()`, then `sys.exit(1)`. No manual command to exit. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2261-L2269】 | `_maybe_restart` prints warning, awaits `bot.close()`, then `sys.exit(1)`; plus manual `!reboot` command (`ENABLE_CMD_REBOOT`) that sleeps 1 s then `os._exit(0)`. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1439-L1471】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1272-L1276】 |
| **Liveness commands** | `!ping` reacts with 🏓; `!health` (admin-only) reports gateway state, latency, Sheets status, uptime, last event age. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2044-L2081】 | `!ping` reaction; `!health` (toggleable) reports latency, Sheets status, uptime; `!reboot` as above. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1098-L1251】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1272-L1276】 |
| **HTTP keepalive endpoints** | aiohttp server via `start_webserver()`; `/` `/ready` `/health` return either deep status or always-200 based on `STRICT_PROBE`; `/healthz` deep check; exposes `_health_json`/`_health_json_ok_always` with 200/206/503 semantics and includes uptime/last event/latency; also serves `/emoji-pad`. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2303-L2495】 | Same server/endpoint strategy (without emoji proxy) using identical payload/status rules and `STRICT_PROBE` gate. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1473-L1538】 |
| **Boot-time keepalive wiring** | `asyncio.create_task(start_webserver())` before `bot.start`. 【F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.py†L2529-L2544】 | Same pattern in `_boot()`. 【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1804-L1812】 |
