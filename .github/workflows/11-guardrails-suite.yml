name: Repository Guardrails

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  suite:
    runs-on: ubuntu-latest
    outputs:
      guardrails_status: ${{ steps.guardrails.outputs.guardrails_status }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Forbidden imports check (get_port path)
        run: |
          chmod +x scripts/ci/check_forbidden_imports.sh
          scripts/ci/check_forbidden_imports.sh
      - name: Run config/docs parity & secret-pattern guard
        id: parity
        continue-on-error: true
        run: |
          status=0
          python scripts/ci/check_env_parity.py --summary guardrails-summary.md || status=$?
          if [ "$status" -ne 0 ]; then
            echo "ENV_PARITY_STATUS=failure" >> "$GITHUB_ENV"
          else
            echo "ENV_PARITY_STATUS=success" >> "$GITHUB_ENV"
          fi
          exit "$status"
      - name: Run Repository Guardrails suite
        id: guardrails
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          status_file=guardrails_status.txt
          exit_code=0
          python scripts/ci/guardrails_suite.py \
            --pr "${{ github.event.pull_request.number || 0 }}" \
            --status-file "$status_file" \
            --summary guardrails-summary.md \
            --json guardrails-results.json \
            --base-ref "origin/${{ github.base_ref || 'main' }}" || exit_code=$?
          if [ -f "$status_file" ]; then
            echo "guardrails_status=$(cat "$status_file")" >> "$GITHUB_OUTPUT"
          else
            echo "guardrails_status=fail" >> "$GITHUB_OUTPUT"
          fi
          exit "$exit_code"
      - name: Post guardrails summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- guardrails-summary -->';
            let body = 'Repository Guardrails summary\n\n' + marker + '\n';
            try {
              body += fs.readFileSync('guardrails-summary.md', 'utf8').trim() + '\n';
            } catch (error) {
              body += 'Guardrails summary unavailable.\n';
            }
            body += marker;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });

            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Fail on guardrails issues
        if: steps.guardrails.outcome == 'failure' || steps.parity.outcome == 'failure'
        run: exit 1
