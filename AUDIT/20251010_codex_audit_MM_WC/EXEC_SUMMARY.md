# Executive Summary â€” C1C Matchmaker & WelcomeCrew (2025-10-10 snapshot)

## Matchmaker (MM)
- **Entrypoint & runtime**: async `main()` starts the Discord client (prefix `!`) and spins up the aiohttp health/emoji-pad server on boot.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L1090-L1105ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2473-L2495ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2530-L2544ã€‘
- **Commands**: recruiter/member tooling (`!clanmatch`, `!clansearch`, `!clan <tag>`), welcome helpers (`!welcome*` via the embedded Cog), and admin probes (`!reload`, `!health`, `!ping`, `!mmhealth`). Panels are owner-locked and rate-limited.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L1566-L1660ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L1799-L1808ã€‘ã€F:AUDIT/20251010_src/MM/welcome.pyâ€ L303-L443ã€‘
- **Listeners & tasks**: reaction flip listener for ğŸ’¡, recruiter daily summary poster (17:30 UTC) targeting `RECRUITERS_THREAD_ID`, scheduled cleanup across configured channel IDs, and a watchdog loop that restarts on disconnect/zombie heuristics.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L1936-L1975ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L660-L724ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2140-L2158ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2162-L2297ã€‘
- **Health surface**: `/`, `/ready`, `/health`, `/healthz`, plus `/emoji-pad`. Default responses are shallow 200s unless `STRICT_PROBE=1`, and deep status exposes last-event age and latency.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2473-L2495ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2306-L2335ã€‘
- **Guild channels & roles**: uses env-driven recruiter/lead/admin role ID allow-lists, thread/channel IDs for summaries and cleanup, and a hard-coded `LOG_CHANNEL_ID=1415330837968191629` for welcome logging plus optional general notice channel.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L1100-L1148ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L98-L108ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2140-L2149ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2500-L2522ã€‘ã€F:AUDIT/20251010_src/MM/welcome.pyâ€ L333-L406ã€‘
- **Google Sheets**: read-only scope against `GOOGLE_SHEET_ID` (`bot_info` tab by default) with cached `get_all_values()`, manual column map (Aâ€“AF), and Welcome templates pulled from `WelcomeTemplates` per call.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L64-L166ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2506-L2513ã€‘

## WelcomeCrew (WC)
- **Entrypoint & runtime**: `_boot()` validates the Discord token, optionally launches the aiohttp health server, and runs a prefix `!` bot with custom help removed.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L80-L115ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1513-L1538ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1753-L1767ã€‘
- **Commands**: admin/maintenance actions covering environment checks, sheet status, backfill, dedupe, reload, health, reboot, and watcher status; no built-in role checks are enforced (env toggles only).ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L237-L327ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1022-L1279ã€‘
- **Listeners & threads**: auto-sync slash command, joins new threads, reacts to socket events, and runs live ticket watchers across Welcome/Promo channels with backfill/update handlers. Watchdog mirrors Matchmakerâ€™s restart heuristics and a 3Ã—/day clan-tag refresh loop.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L280-L359ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1398-L1471ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1540-L1593ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1644-L1752ã€‘
- **Health surface**: same trio of `/`, `/ready`, `/health` plus `/healthz`, driven by `STRICT_PROBE`, with optional notify channel fallbacks for thread writes.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L71-L83ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1505-L1538ã€‘
- **Guild channels & roles**: env-driven IDs for Welcome/Promo parents, notify channel/role, optional log channel, and toggles for watcher scopes; private-thread joins are gated by `ALLOW_SELF_JOIN_PRIVATE`.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L40-L83ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L632-L708ã€‘
- **Google Sheets**: service-account writer that ensures headers on `Sheet1`/`Sheet4`, caches worksheet handles, throttles writes with retry/backoff, and periodically reloads the `clanlist` tag tab (column autodetect or configured index).ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L121-L156ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L306-L354ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L463-L520ã€‘

## Top 10 Current Risks
1. **Blocking Sheets access in Matchmaker** â€” `get_rows()` and friends call gspread synchronously on the gateway loop; heavy sheets or network stalls will freeze interactions.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L123-L144ã€‘
2. **Blocking Sheets/tag reload in WelcomeCrew** â€” `_load_clan_tags()` executes gspread reads inline from message handlers (via `_match_tag_in_text`), risking event-loop starvation during cache misses.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L306-L354ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L622-L708ã€‘
3. **No permission gates on WelcomeCrew commands** â€” every prefix command is callable by any member when enabled via env toggles, leaving destructive actions (e.g., `!reboot`, `!dedupe_sheet`) unguarded.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1022-L1279ã€‘
4. **Hard-coded welcome log channel in Matchmaker** â€” `LOG_CHANNEL_ID=1415330837968191629` is baked into source, making per-guild deployments brittle and leaking private IDs in logs.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2500-L2522ã€‘
5. **Matchmaker welcome sheet fetch per command** â€” `get_welcome_rows()` re-authorizes and pulls the entire template tab on each welcome action, adding latency and raising rate-limit exposure.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2506-L2513ã€‘ã€F:AUDIT/20251010_src/MM/welcome.pyâ€ L303-L406ã€‘
6. **`os._exit`/`sys.exit` restarts** â€” both watchdogs and WelcomeCrewâ€™s `!reboot` exit the interpreter abruptly, bypassing cleanup and leaving hosting platforms to restart the process.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2261-L2297ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1272-L1276ã€‘
7. **Sheets write posture lacks per-call guardrails** â€” WelcomeCrew batches writes but still runs `append_row`/`update` in worker threads without centralized quota awareness; concurrent backfills risk hitting API quotas despite retries.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L463-L520ã€‘
8. **Shared watchdog heuristic duplication** â€” identical zombie detection heuristics across bots increase the chance of systemic restarts if a platform issue trips both simultaneously.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2261-L2297ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1433-L1471ã€‘
9. **Panel/thread cleanup requires privileged IDs** â€” misconfigured `CLEANUP_THREAD_IDS` or recruiter thread IDs silently skip work; there is no alerting when fetches fail beyond stdout prints.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2140-L2156ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L660-L724ã€‘
10. **Notify fallback depends on channel reachability** â€” WelcomeCrewâ€™s notify channel flow silently drops failures after logging to stdout; no escalation when fallback messaging cannot be delivered.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L632-L708ã€‘

## Duplicate / Near-Duplicate Hotspots
- **Watchdog restart logic** â€” `_watchdog` and `_maybe_restart` implementations are nearly identical between Matchmaker and WelcomeCrew, differing only in logging text.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2261-L2297ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1433-L1471ã€‘
- **Health endpoint handlers** â€” the aiohttp health routes share almost identical response bodies/`STRICT_PROBE` handling across both bots, duplicating maintenance burden.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2303-L2335ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1473-L1511ã€‘
- **Socket event bookkeeping** â€” both clients register the same `on_socket_response`/`on_connect`/`on_resumed` sequences to maintain heartbeat state, indicating a candidate for shared utility extraction.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2162-L2192ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1398-L1425ã€‘

## Feature-Parity Merge Checklist (no new features)
1. **Unify shared infrastructure** â€” extract watchdog + health server helpers into a shared module while preserving existing behavior toggles (`STRICT_PROBE`, restart thresholds).ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2261-L2335ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1433-L1511ã€‘
2. **Normalize permission gating** â€” decide on common role/perm requirements, wire them into WelcomeCrew commands, and ensure Matchmakerâ€™s welcome Cog uses the shared policy.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L1100-L1148ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1022-L1279ã€‘
3. **Abstract Sheets access layer** â€” wrap gspread interactions with async-friendly helpers (to-thread + caching) shared by both bots to eliminate gateway blocking and align retry/backoff semantics.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L123-L166ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L306-L354ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L463-L520ã€‘
4. **Parameterize guild-specific IDs** â€” move hard-coded channel IDs (e.g., Matchmaker log channel) into environment variables and document them in a shared config schema.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2500-L2522ã€‘
5. **Consolidate welcome templating** â€” ensure both bots (and the Welcome Cog) consume the same cached welcome/tag data structures to prevent redundant sheet fetches and keep placeholders consistent.ã€F:AUDIT/20251010_src/MM/welcome.pyâ€ L303-L406ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L306-L354ã€‘
6. **Align health/telemetry reporting** â€” adopt a shared payload schema for health endpoints and ensure both bots expose identical keys for monitors before merging services.ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2306-L2335ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1473-L1511ã€‘
7. **Regression checklist & smoke tests** â€” script end-to-end validation covering recruiter panels, welcome posting, ticket logging, and sheet writes under the merged runtime to guarantee feature parity.
