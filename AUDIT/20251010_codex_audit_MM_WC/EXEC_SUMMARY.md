# Codex Audit â€” Matchmaker & WelcomeCrew (2025-10-10)

## Matchmaker / Achievements snapshot
- **Entrypoint & runtime:** `c1c_claims_appreciation.py` boots a Flask keep-alive at `/`, then launches a Discord bot with shared CoreOps prefixes (`!sc`, `!rem`, `!wc`, `!mm`, fallback `!`) and scoped intent flags before spawning the asyncio login loop.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L20-L29ã€‘ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L98-L166ã€‘ã€F:AUDIT/20251010_src/MM/core/prefix.pyâ€ L6-L33ã€‘ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1556-L1661ã€‘
- **Configuration surface:** Sheets loader pulls `General`, `Categories`, `Achievements`, `Levels`, and `Reasons` tabs (read-only scope) into the in-memory `CFG` object that advertises the active claims thread, levels channel, audit log, and Guardian Knights role IDs.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L111-L138ã€‘ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L200-L244ã€‘
- **Commands:**
  - Prefix commands in the monolith cover help, config introspection (`!testconfig`, `!configstatus`, `!reloadconfig`, `!listach`, `!findach`, `!testach`, `!testlevel`, `!flushpraise`, `!ping`) guarded by `_is_staff` where appropriate.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1215-L1378ã€‘
  - CoreOps cog exposes administrative actions (`!health`, `!digest`, `!reload`, `!checksheet`, `!env`, `!reboot`/aliases) using runtime telemetry and the config snapshot for embeds.ã€F:AUDIT/20251010_src/MM/cogs/ops.pyâ€ L59-L305ã€‘
  - Shards cog adds OCR diagnostics plus `!shards`/`!mercy` thread workflows tied to clan configs and Sheets storage.ã€F:AUDIT/20251010_src/MM/cogs/shards/cog.pyâ€ L41-L418ã€‘
- **Listeners & tasks:** The monolith listens for member updates and claim-thread posts to drive level embeds, initiate claim pickers, and audit logging, while global gateway hooks maintain watchdog telemetry used by the CoreOps diagnostics.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1431-L1543ã€‘ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1556-L1639ã€‘

## WelcomeCrew snapshot
- **Entrypoint & runtime:** `bot_welcomecrew.py` hardcodes the `!` prefix, enables message-content intents, and orchestrates an aiohttp keep-alive server with `/`, `/ready`, `/health`, and `/healthz` JSON probes while booting the Discord client.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L32-L113ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L89-L93ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1482-L1538ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1804-L1813ã€‘
- **Configuration surface:** Environment flags supply channel IDs (welcome, promo, notify), optional ping role, Sheets identifiers (`SHEET1_NAME`, `SHEET4_NAME`, `CLANLIST_TAB_NAME`), cache TTLs, toggles, and timezone handling, all consumed by helper loaders and watchers.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L32-L120ã€‘
- **Commands:** Prefix commands cover environment checks, ping, Sheets status, backfill orchestration (start/stop/details), clan tag debugging, dedupe, cache reload, health, checksheet, reboot, and watcher status; slash `/help` mirrors the embed summary. None enforce permission checks beyond env toggles in this snapshot.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L237-L279ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1007-L1279ã€‘
- **Listeners & tasks:** Live thread watchers respond to close markers, archival events, and tag detections for welcome/promo threads, while gateway hooks maintain watchdog state that can exit the process after prolonged disconnects or zombie gateways.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1398-L1803ã€‘

## Shared operational facts
- **Prefixes:** Matchmaker honours scoped prefixes (`!sc`, `!rem`, `!wc`, `!mm`) plus plain `!`; WelcomeCrew only listens to `!` in this build.ã€F:AUDIT/20251010_src/MM/core/prefix.pyâ€ L6-L33ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L89-L93ã€‘
- **Health endpoints:** Matchmaker exposes a Render-style Flask `GET /` that returns `"ok"`; WelcomeCrew runs aiohttp JSON probes that optionally downgrade to HTTP 206/503 depending on gateway telemetry or always 200 when `STRICT_PROBE` is off.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L19-L29ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1482-L1529ã€‘
- **Channel & role IDs:** Matchmaker pulls IDs from the `General` worksheet into `CFG` (claims thread, levels channel, audit log, Guardian Knights role). WelcomeCrew relies on env vars for welcome/promo channels, optional notify role, and toggles auto-joining or watcher behaviour off those IDs.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L221-L243ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L32-L88ã€‘
- **Google Sheets touchpoints:** Matchmaker reads multiple tabs via gspread/pandas in `load_config` and writes to shards tabs through the sheets adapter; WelcomeCrew performs read/write operations on Sheet1, Sheet4, and `clanlist`, plus dedupe and backfill updates.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L200-L279ã€‘ã€F:AUDIT/20251010_src/MM/cogs/shards/sheets_adapter.pyâ€ L139-L185ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L306-L405ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1216-L1269ã€‘

## Top risks (current snapshot)
1. **Blocking config reloads freeze Matchmakerâ€™s gateway loop:** every reload path (manual, auto-refresh, startup retry) calls the synchronous Sheets loader on the event loop, so slow Sheets stalls command processing.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L200-L279ã€‘ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1283-L1293ã€‘ã€F:AUDIT/20251010_src/MM/cogs/ops.pyâ€ L165-L238ã€‘
2. **WelcomeCrew admin commands remain world-writeable:** destructive commands (`!reboot`, `!dedupe_sheet`, `!backfill_tickets`, etc.) ship without any permission guards beyond env toggles, allowing any member to reboot the bot or hammer Sheets.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1098-L1276ã€‘
3. **WelcomeCrew clan-tag cache rehydration blocks the gateway:** `_load_clan_tags` performs `worksheet.get_all_values()` synchronously and is invoked during message handling whenever the cache is stale, risking multi-second stalls under API hiccups.ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L306-L353ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1665-L1718ã€‘
4. **Shard summary writer still issues empty `append_row` calls:** Matchmakerâ€™s sheets adapter appends an empty row before the payload when data exists, which gspread rejects and leaves shard dashboards stale.ã€F:AUDIT/20251010_src/MM/cogs/shards/sheets_adapter.pyâ€ L139-L165ã€‘
5. **Duplicate help implementations compete for the `!help` name:** the monolith registers a help command even though the `claims.help` extension already installs one, risking divergence and confusion for CoreOps documentation updates.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1215-L1245ã€‘ã€F:AUDIT/20251010_src/MM/claims/help.pyâ€ L126-L143ã€‘

## Duplicate hotspots to track
- **Help command duplication:** both the monolith and the `claims.help` extension register `!help` with overlapping copy, creating maintenance drift and inconsistent embeds.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1215-L1245ã€‘ã€F:AUDIT/20251010_src/MM/claims/help.pyâ€ L126-L143ã€‘
- **Shared error handler boilerplate:** Matchmaker and WelcomeCrew each define the same `on_command_error` handler that only replays exceptions, suggesting a shared utility or base cog could replace bespoke copies.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1420-L1428ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1635-L1642ã€‘
- **Ping commands mirror each other:** both bots export a `!ping` that solely reacts with ğŸ“, a trivial duplication that could live in a shared module during convergence.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1371-L1378ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1098-L1106ã€‘

## Feature-parity merge checklist (no new features)
1. **Normalize prefixes and help ownership:** confirm the merged service keeps scoped prefixes for CoreOps while reconciling the dual `!help` implementations into a single source of truth before toggling modules on.ã€F:AUDIT/20251010_src/MM/core/prefix.pyâ€ L6-L33ã€‘ã€F:AUDIT/20251010_src/MM/claims/help.pyâ€ L126-L143ã€‘
2. **Lift permission guards from Reminder history:** gate WelcomeCrewâ€™s maintenance commands behind `Manage Guild` (or equivalent) and ensure Matchmaker staff checks remain intact when commands consolidate.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L1248-L1370ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1022-L1279ã€‘
3. **Offload blocking Sheets I/O before combining loops:** wrap Matchmakerâ€™s config loader and WelcomeCrewâ€™s clan tag fetcher in `asyncio.to_thread`/`run_in_executor`, then update all callers to await the async wrappers to preserve responsiveness.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L200-L279ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L306-L405ã€‘
4. **Reconcile health probes and watchdog expectations:** decide on a unified keep-alive contract (Flask vs aiohttp JSON) and align watchdog thresholds before routing traffic through shared infra.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L19-L29ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1482-L1538ã€‘
5. **Map Sheets dependencies per tab:** ensure the merged deployment provisions the same Google Sheets tabs/ranges (General/Categories/Achievements/Levels/Reasons vs Sheet1/Sheet4/clanlist) and reconciles service-account scopes before cutting traffic.ã€F:AUDIT/20251010_src/MM/c1c_claims_appreciation.pyâ€ L200-L244ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L306-L405ã€‘
6. **Validate watcher coverage:** cross-test shard thread OCR flows and welcome/promo watchers after merge to confirm concurrency primitives (views, tasks, watchdog) remain responsive under shared latency.ã€F:AUDIT/20251010_src/MM/cogs/shards/cog.pyâ€ L126-L344ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1398-L1760ã€‘
7. **Exercise admin diagnostics end-to-end:** run CoreOps (`!health`, `!digest`, `!checksheet`) and WelcomeCrew maintenance commands post-merge to verify telemetry embeds, Sheet reads/writes, and reboot semantics survive the combined runtime.ã€F:AUDIT/20251010_src/MM/cogs/ops.pyâ€ L59-L238ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1107-L1280ã€‘
