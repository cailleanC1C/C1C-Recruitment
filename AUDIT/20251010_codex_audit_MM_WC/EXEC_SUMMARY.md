# Codex Audit — Matchmaker & WelcomeCrew (2025-10-10)

## Matchmaker / Achievements snapshot
- **Entrypoint & runtime:** `c1c_claims_appreciation.py` boots a Flask keep-alive at `/`, then launches a Discord bot with shared CoreOps prefixes (`!sc`, `!rem`, `!wc`, `!mm`, fallback `!`) and scoped intent flags before spawning the asyncio login loop.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L20-L29】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L98-L166】【F:AUDIT/20251010_src/MM/core/prefix.py†L6-L33】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1556-L1661】
- **Configuration surface:** Sheets loader pulls `General`, `Categories`, `Achievements`, `Levels`, and `Reasons` tabs (read-only scope) into the in-memory `CFG` object that advertises the active claims thread, levels channel, audit log, and Guardian Knights role IDs.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L111-L138】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L200-L244】
- **Commands:**
  - Prefix commands in the monolith cover help, config introspection (`!testconfig`, `!configstatus`, `!reloadconfig`, `!listach`, `!findach`, `!testach`, `!testlevel`, `!flushpraise`, `!ping`) guarded by `_is_staff` where appropriate.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1215-L1378】
  - CoreOps cog exposes administrative actions (`!health`, `!digest`, `!reload`, `!checksheet`, `!env`, `!reboot`/aliases) using runtime telemetry and the config snapshot for embeds.【F:AUDIT/20251010_src/MM/cogs/ops.py†L59-L305】
  - Shards cog adds OCR diagnostics plus `!shards`/`!mercy` thread workflows tied to clan configs and Sheets storage.【F:AUDIT/20251010_src/MM/cogs/shards/cog.py†L41-L418】
- **Listeners & tasks:** The monolith listens for member updates and claim-thread posts to drive level embeds, initiate claim pickers, and audit logging, while global gateway hooks maintain watchdog telemetry used by the CoreOps diagnostics.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1431-L1543】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1556-L1639】

## WelcomeCrew snapshot
- **Entrypoint & runtime:** `bot_welcomecrew.py` hardcodes the `!` prefix, enables message-content intents, and orchestrates an aiohttp keep-alive server with `/`, `/ready`, `/health`, and `/healthz` JSON probes while booting the Discord client.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L32-L113】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L89-L93】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1482-L1538】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1804-L1813】
- **Configuration surface:** Environment flags supply channel IDs (welcome, promo, notify), optional ping role, Sheets identifiers (`SHEET1_NAME`, `SHEET4_NAME`, `CLANLIST_TAB_NAME`), cache TTLs, toggles, and timezone handling, all consumed by helper loaders and watchers.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L32-L120】
- **Commands:** Prefix commands cover environment checks, ping, Sheets status, backfill orchestration (start/stop/details), clan tag debugging, dedupe, cache reload, health, checksheet, reboot, and watcher status; slash `/help` mirrors the embed summary. None enforce permission checks beyond env toggles in this snapshot.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L237-L279】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1007-L1279】
- **Listeners & tasks:** Live thread watchers respond to close markers, archival events, and tag detections for welcome/promo threads, while gateway hooks maintain watchdog state that can exit the process after prolonged disconnects or zombie gateways.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1398-L1803】

## Shared operational facts
- **Prefixes:** Matchmaker honours scoped prefixes (`!sc`, `!rem`, `!wc`, `!mm`) plus plain `!`; WelcomeCrew only listens to `!` in this build.【F:AUDIT/20251010_src/MM/core/prefix.py†L6-L33】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L89-L93】
- **Health endpoints:** Matchmaker exposes a Render-style Flask `GET /` that returns `"ok"`; WelcomeCrew runs aiohttp JSON probes that optionally downgrade to HTTP 206/503 depending on gateway telemetry or always 200 when `STRICT_PROBE` is off.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L19-L29】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1482-L1529】
- **Channel & role IDs:** Matchmaker pulls IDs from the `General` worksheet into `CFG` (claims thread, levels channel, audit log, Guardian Knights role). WelcomeCrew relies on env vars for welcome/promo channels, optional notify role, and toggles auto-joining or watcher behaviour off those IDs.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L221-L243】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L32-L88】
- **Google Sheets touchpoints:** Matchmaker reads multiple tabs via gspread/pandas in `load_config` and writes to shards tabs through the sheets adapter; WelcomeCrew performs read/write operations on Sheet1, Sheet4, and `clanlist`, plus dedupe and backfill updates.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L200-L279】【F:AUDIT/20251010_src/MM/cogs/shards/sheets_adapter.py†L139-L185】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L306-L405】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1216-L1269】

## Top risks (current snapshot)
1. **Blocking config reloads freeze Matchmaker’s gateway loop:** every reload path (manual, auto-refresh, startup retry) calls the synchronous Sheets loader on the event loop, so slow Sheets stalls command processing.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L200-L279】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1283-L1293】【F:AUDIT/20251010_src/MM/cogs/ops.py†L165-L238】
2. **WelcomeCrew admin commands remain world-writeable:** destructive commands (`!reboot`, `!dedupe_sheet`, `!backfill_tickets`, etc.) ship without any permission guards beyond env toggles, allowing any member to reboot the bot or hammer Sheets.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1098-L1276】
3. **WelcomeCrew clan-tag cache rehydration blocks the gateway:** `_load_clan_tags` performs `worksheet.get_all_values()` synchronously and is invoked during message handling whenever the cache is stale, risking multi-second stalls under API hiccups.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L306-L353】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1665-L1718】
4. **Shard summary writer still issues empty `append_row` calls:** Matchmaker’s sheets adapter appends an empty row before the payload when data exists, which gspread rejects and leaves shard dashboards stale.【F:AUDIT/20251010_src/MM/cogs/shards/sheets_adapter.py†L139-L165】
5. **Duplicate help implementations compete for the `!help` name:** the monolith registers a help command even though the `claims.help` extension already installs one, risking divergence and confusion for CoreOps documentation updates.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1215-L1245】【F:AUDIT/20251010_src/MM/claims/help.py†L126-L143】

## Duplicate hotspots to track
- **Help command duplication:** both the monolith and the `claims.help` extension register `!help` with overlapping copy, creating maintenance drift and inconsistent embeds.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1215-L1245】【F:AUDIT/20251010_src/MM/claims/help.py†L126-L143】
- **Shared error handler boilerplate:** Matchmaker and WelcomeCrew each define the same `on_command_error` handler that only replays exceptions, suggesting a shared utility or base cog could replace bespoke copies.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1420-L1428】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1635-L1642】
- **Ping commands mirror each other:** both bots export a `!ping` that solely reacts with 🏓, a trivial duplication that could live in a shared module during convergence.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1371-L1378】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1098-L1106】

## Feature-parity merge checklist (no new features)
1. **Normalize prefixes and help ownership:** confirm the merged service keeps scoped prefixes for CoreOps while reconciling the dual `!help` implementations into a single source of truth before toggling modules on.【F:AUDIT/20251010_src/MM/core/prefix.py†L6-L33】【F:AUDIT/20251010_src/MM/claims/help.py†L126-L143】
2. **Lift permission guards from Reminder history:** gate WelcomeCrew’s maintenance commands behind `Manage Guild` (or equivalent) and ensure Matchmaker staff checks remain intact when commands consolidate.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1248-L1370】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1022-L1279】
3. **Offload blocking Sheets I/O before combining loops:** wrap Matchmaker’s config loader and WelcomeCrew’s clan tag fetcher in `asyncio.to_thread`/`run_in_executor`, then update all callers to await the async wrappers to preserve responsiveness.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L200-L279】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L306-L405】
4. **Reconcile health probes and watchdog expectations:** decide on a unified keep-alive contract (Flask vs aiohttp JSON) and align watchdog thresholds before routing traffic through shared infra.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L19-L29】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1482-L1538】
5. **Map Sheets dependencies per tab:** ensure the merged deployment provisions the same Google Sheets tabs/ranges (General/Categories/Achievements/Levels/Reasons vs Sheet1/Sheet4/clanlist) and reconciles service-account scopes before cutting traffic.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L200-L244】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L306-L405】
6. **Validate watcher coverage:** cross-test shard thread OCR flows and welcome/promo watchers after merge to confirm concurrency primitives (views, tasks, watchdog) remain responsive under shared latency.【F:AUDIT/20251010_src/MM/cogs/shards/cog.py†L126-L344】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1398-L1760】
7. **Exercise admin diagnostics end-to-end:** run CoreOps (`!health`, `!digest`, `!checksheet`) and WelcomeCrew maintenance commands post-merge to verify telemetry embeds, Sheet reads/writes, and reboot semantics survive the combined runtime.【F:AUDIT/20251010_src/MM/cogs/ops.py†L59-L238】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1107-L1280】
