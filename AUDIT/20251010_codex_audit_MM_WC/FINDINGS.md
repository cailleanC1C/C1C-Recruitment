# Findings — Matchmaker & WelcomeCrew (2025-10-10)

## Duplicate & near-duplicate code
- **Dual `!help` implementations (Matchmaker):** both the monolith and the `claims.help` extension register a `help` command, duplicating copy and risking divergence when CoreOps docs change.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1215-L1245】【F:AUDIT/20251010_src/MM/claims/help.py†L126-L143】  *Present.*
- **Shared error handler boilerplate:** Matchmaker and WelcomeCrew define the same `on_command_error` that silently ignores `CommandNotFound` and echoes other exceptions, a near-identical snippet suitable for a shared helper.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1420-L1428】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1635-L1642】  *Present across repos.*
- **Ping command clones:** Both bots expose `!ping` as a reaction-only heartbeat without additional logic, indicating another reuse candidate when consolidating maintenance utilities.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1371-L1378】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1098-L1106】  *Present across repos.*

## Prior review reconciliation
| Finding | Source review | Status | Current evidence |
| --- | --- | --- | --- |
| F-01 — Blocking `load_config` | Achievements Code Review (2025-10-05) | **Present** | Reload paths still call the synchronous Sheets loader directly from async handlers (`!reloadconfig`, CoreOps `reload`, auto-refresh).【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L200-L279】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1283-L1293】【F:AUDIT/20251010_src/MM/cogs/ops.py†L165-L238】 |
| F-02 — Digest readiness bug | Achievements Code Review (2025-10-05) | **Present** | `build_digest_line` still overwrites the runtime readiness flag with the config flag before formatting.【F:AUDIT/20251010_src/MM/claims/ops.py†L86-L111】 |
| F-03 — Shards summary append crash | Achievements Code Review (2025-10-05) | **Present** | `set_summary_msg` continues to append an empty row when data already exists, provoking gspread errors.【F:AUDIT/20251010_src/MM/cogs/shards/sheets_adapter.py†L139-L165】 |
| F-01 — Missing admin guards | WelcomeCrew Review (2025-10-05) | **Present** | Maintenance commands (e.g., `!reboot`, `!backfill_tickets`) still lack `has_permissions` decorators; any member can invoke them.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1132-L1276】 |
| F-02 — Blocking clan tag reload | WelcomeCrew Review (2025-10-05) | **Present** | `_load_clan_tags` performs blocking `worksheet.get_all_values()` calls on the gateway path, and watchers invoke it when caches expire.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L306-L353】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1665-L1718】 |

## Permissions & hard-coded identifiers
- **Matchmaker:** Staff-only commands rely on `_is_staff`, which grants access to members with `Manage Guild` or the Guardian Knights role ID loaded from the `General` sheet (`guardian_knights_role_id`). Channel and thread targets (claims thread, levels channel, audit log) are likewise fetched from the sheet and cached in `CFG` for embed status checks.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L221-L243】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1248-L1370】
- **WelcomeCrew:** All operational IDs come from environment variables (welcome/promo channel IDs, notify channel/role, sheet names), but no command-level permission decorators protect destructive actions. Watchers gate behaviour via env toggles yet still trust hard-coded prefixes and channel IDs for joining threads and logging actions.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L32-L113】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1007-L1280】

## Event-loop safety & concurrency
- **Blocking operations:** Matchmaker executes Google Sheets and pandas I/O synchronously inside `load_config`, `reloadconfig`, CoreOps `reload`, and the auto-refresh loop, which all run on the Discord gateway loop. WelcomeCrew similarly calls `_load_clan_tags` (gspread `get_all_values`) and other sheet helpers directly from message watchers and backfill routines without offloading to threads.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L200-L279】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1545-L1560】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L306-L405】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1665-L1718】
- **Watchdog tasks:** Both bots maintain watchdog timers—Matchmaker tracks `_LAST_EVENT_TS` and toggles `BOT_CONNECTED` in gateway hooks, while WelcomeCrew runs a scheduled `_watchdog` loop that can call `sys.exit(1)` on zombie gateways or prolonged disconnects.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L66-L160】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L669-L1472】

## Sheets read/write posture
- **Matchmaker:** Uses a service-account scope (`spreadsheets.readonly`) to fetch config tabs, with optional Excel fallback via pandas. Shards features write to `SUMMARY_MSGS`, `SHARD_SNAPSHOTS`, and `SHARD_EVENTS` via gspread `append_row`/`update`, currently synchronously.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L145-L279】【F:AUDIT/20251010_src/MM/cogs/shards/sheets_adapter.py†L139-L200】
- **WelcomeCrew:** Establishes a cached gspread client (`gs_client`) for read/write access, revalidates headers, and throttles writes with sleep-based backoff. Commands such as `!checksheet`, `!dedupe_sheet`, and backfill flows perform synchronous `get_all_values`, `append_row`, and `update` operations on Sheet1/Sheet4, plus dedupe logic executed via `_run_blocking` wrappers for some calls but not the cache reload path.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L115-L405】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1132-L1269】

## Health & self-ping logic
- **Matchmaker:** Relies on a Render-style Flask `/` returning `ok` and a `!ping` reaction command; CoreOps `!health`/`!digest` embed the watchdog state, last event age, and config counts for operators.【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L19-L29】【F:AUDIT/20251010_src/MM/c1c_claims_appreciation.py†L1360-L1409】【F:AUDIT/20251010_src/MM/cogs/ops.py†L59-L162】
- **WelcomeCrew:** Runs an aiohttp server exposing `/`, `/ready`, `/health`, and `/healthz` with JSON payloads that reflect `_LAST_EVENT_TS`, latency, and `STRICT_PROBE`. The watchdog task may close the client when idle/disconnected thresholds are breached, while `!ping` reacts locally.【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1482-L1538】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1448-L1529】【F:AUDIT/20251010_src/WC/bot_welcomecrew.py†L1098-L1106】
