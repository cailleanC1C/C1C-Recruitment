# Gateway Keepalive & Watchdog Comparison

| Aspect | Matchmaker (MM) | WelcomeCrew (WC) |
| --- | --- | --- |
| **Gateway instrumentation** | `on_socket_response` calls `_mark_event()`; `on_connect`/`on_resumed` flip `BOT_CONNECTED=True` and `_mark_event()`; `on_ready` records `_LAST_READY_TS`, marks event, and idempotently starts `_watchdog`, scheduled cleanup, and refresh tasks; `on_disconnect` flags `BOT_CONNECTED=False` and records `_LAST_DISCONNECT_TS`. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2161-L2254ã€‘ | Same event coverage (`on_socket_response`, `on_connect`, `on_resumed`, `on_ready`, `on_disconnect`) with identical state flips and `_watchdog` start. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1397-L1437ã€‘ |
| **Keepalive state tracked** | Globals: `BOT_CONNECTED`, `_LAST_READY_TS`, `_LAST_DISCONNECT_TS`, `_LAST_EVENT_TS`; `_mark_event()` timestamps gateway traffic. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2130-L2140ã€‘ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2256-L2276ã€‘ | Same globals and `_mark_event()` helper. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L662-L702ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1397-L1455ã€‘ |
| **Watchdog cadence** | `@tasks.loop(seconds=WATCHDOG_CHECK_SEC)` with env default 60â€¯s. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2258-L2274ã€‘ | Identical 60â€¯s loop via `WATCHDOG_CHECK_SEC`. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L696-L1450ã€‘ |
| **Zombie detection** | If connected and no events for >600â€¯s with latency missing or >10â€¯s, restart via `_maybe_restart("zombieâ€¦")`. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2275-L2286ã€‘ | Same 600â€¯s + latency>10 guard; message text slightly different but behavior matches. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1452-L1461ã€‘ |
| **Disconnect watchdog** | If disconnected for >`WATCHDOG_MAX_DISCONNECT_SEC` (default 600â€¯s) trigger restart. Tracks first observed disconnect time. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2288-L2297ã€‘ | Same threshold/logic. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1464-L1471ã€‘ |
| **Restart action** | `_maybe_restart` logs warning, awaits `bot.close()`, then `sys.exit(1)`. No manual command to exit. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2261-L2269ã€‘ | `_maybe_restart` prints warning, awaits `bot.close()`, then `sys.exit(1)`; plus manual `!reboot` command (`ENABLE_CMD_REBOOT`) that sleeps 1â€¯s then `os._exit(0)`. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1439-L1471ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1272-L1276ã€‘ |
| **Liveness commands** | `!ping` reacts with ğŸ“; `!health` (admin-only) reports gateway state, latency, Sheets status, uptime, last event age. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2044-L2081ã€‘ | `!ping` reaction; `!health` (toggleable) reports latency, Sheets status, uptime; `!reboot` as above. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1098-L1251ã€‘ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1272-L1276ã€‘ |
| **HTTP keepalive endpoints** | aiohttp server via `start_webserver()`; `/` `/ready` `/health` return either deep status or always-200 based on `STRICT_PROBE`; `/healthz` deep check; exposes `_health_json`/`_health_json_ok_always` with 200/206/503 semantics and includes uptime/last event/latency; also serves `/emoji-pad`. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2303-L2495ã€‘ | Same server/endpoint strategy (without emoji proxy) using identical payload/status rules and `STRICT_PROBE` gate. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1473-L1538ã€‘ |
| **Boot-time keepalive wiring** | `asyncio.create_task(start_webserver())` before `bot.start`. ã€F:AUDIT/20251010_src/MM/bot_clanmatch_prefix.pyâ€ L2529-L2544ã€‘ | Same pattern in `_boot()`. ã€F:AUDIT/20251010_src/WC/bot_welcomecrew.pyâ€ L1804-L1812ã€‘ |
