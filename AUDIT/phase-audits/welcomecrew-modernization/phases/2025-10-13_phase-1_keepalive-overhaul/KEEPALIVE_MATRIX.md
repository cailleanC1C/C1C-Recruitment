# Gateway Keepalive & Watchdog Comparison

| Aspect | Matchmaker (MM) | WelcomeCrew (WC) |
| --- | --- | --- |
| **Gateway instrumentation** | `on_socket_response` calls `_mark_event()`; `on_connect`/`on_resumed` flip `BOT_CONNECTED=True` and `_mark_event()`; `on_ready` records `_LAST_READY_TS`, marks event, and idempotently starts `_watchdog`, scheduled cleanup, and refresh tasks; `on_disconnect` flags `BOT_CONNECTED=False` and records `_LAST_DISCONNECT_TS`. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2161-L2254„Äë | Same event coverage (`on_socket_response`, `on_connect`, `on_resumed`, `on_ready`, `on_disconnect`) with identical state flips and `_watchdog` start. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1397-L1437„Äë |
| **Keepalive state tracked** | Globals: `BOT_CONNECTED`, `_LAST_READY_TS`, `_LAST_DISCONNECT_TS`, `_LAST_EVENT_TS`; `_mark_event()` timestamps gateway traffic. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2130-L2140„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2256-L2276„Äë | Same globals and `_mark_event()` helper. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L662-L702„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1397-L1455„Äë |
| **Watchdog cadence** | `@tasks.loop(seconds=WATCHDOG_CHECK_SEC)` with env default 60‚ÄØs. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2258-L2274„Äë | Identical 60‚ÄØs loop via `WATCHDOG_CHECK_SEC`. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L696-L1450„Äë |
| **Zombie detection** | If connected and no events for >600‚ÄØs with latency missing or >10‚ÄØs, restart via `_maybe_restart("zombie‚Ä¶")`. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2275-L2286„Äë | Same 600‚ÄØs + latency>10 guard; message text slightly different but behavior matches. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1452-L1461„Äë |
| **Disconnect watchdog** | If disconnected for >`WATCHDOG_MAX_DISCONNECT_SEC` (default 600‚ÄØs) trigger restart. Tracks first observed disconnect time. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2288-L2297„Äë | Same threshold/logic. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1464-L1471„Äë |
| **Restart action** | `_maybe_restart` logs warning, awaits `bot.close()`, then `sys.exit(1)`. No manual command to exit. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2261-L2269„Äë | `_maybe_restart` prints warning, awaits `bot.close()`, then `sys.exit(1)`; plus manual `!reboot` command (`ENABLE_CMD_REBOOT`) that sleeps 1‚ÄØs then `os._exit(0)`. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1439-L1471„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1272-L1276„Äë |
| **Liveness commands** | `!ping` reacts with üèì; `!health` (admin-only) reports gateway state, latency, Sheets status, uptime, last event age. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2044-L2081„Äë | `!ping` reaction; `!health` (toggleable) reports latency, Sheets status, uptime; `!reboot` as above. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1098-L1251„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1272-L1276„Äë |
| **HTTP keepalive endpoints** | aiohttp server via `start_webserver()`; `/` `/ready` `/health` return either deep status or always-200 based on `STRICT_PROBE`; `/healthz` deep check; exposes `_health_json`/`_health_json_ok_always` with 200/206/503 semantics and includes uptime/last event/latency; also serves `/emoji-pad`. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2303-L2495„Äë | Same server/endpoint strategy (without emoji proxy) using identical payload/status rules and `STRICT_PROBE` gate. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1473-L1538„Äë |
| **Boot-time keepalive wiring** | `asyncio.create_task(start_webserver())` before `bot.start`. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2529-L2544„Äë | Same pattern in `_boot()`. „ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1804-L1812„Äë |

Doc last updated: 2025-10-13 (v0.9.5)
