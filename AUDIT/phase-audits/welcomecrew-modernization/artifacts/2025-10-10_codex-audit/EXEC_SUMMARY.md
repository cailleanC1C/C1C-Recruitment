# Executive Summary ‚Äî C1C Matchmaker & WelcomeCrew (2025-10-10 snapshot)

## Matchmaker (MM)
- **Entrypoint & runtime**: async `main()` starts the Discord client (prefix `!`) and spins up the aiohttp health/emoji-pad server on boot.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L1090-L1105„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2473-L2495„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2530-L2544„Äë
- **Commands**: recruiter/member tooling (`!clanmatch`, `!clansearch`, `!clan <tag>`), welcome helpers (`!welcome*` via the embedded Cog), and admin probes (`!reload`, `!health`, `!ping`, `!mmhealth`). Panels are owner-locked and rate-limited.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L1566-L1660„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L1799-L1808„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/welcome.py‚Ä†L303-L443„Äë
- **Listeners & tasks**: reaction flip listener for üí°, recruiter daily summary poster (17:30 UTC) targeting `RECRUITERS_THREAD_ID`, scheduled cleanup across configured channel IDs, and a watchdog loop that restarts on disconnect/zombie heuristics.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L1936-L1975„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L660-L724„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2140-L2158„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2162-L2297„Äë
- **Health surface**: `/`, `/ready`, `/health`, `/healthz`, plus `/emoji-pad`. Default responses are shallow 200s unless `STRICT_PROBE=1`, and deep status exposes last-event age and latency.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2473-L2495„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2306-L2335„Äë
- **Guild channels & roles**: uses env-driven recruiter/lead/admin role ID allow-lists, thread/channel IDs for summaries and cleanup, and a hard-coded `LOG_CHANNEL_ID=1415330837968191629` for welcome logging plus optional general notice channel.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L1100-L1148„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L98-L108„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2140-L2149„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2500-L2522„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/welcome.py‚Ä†L333-L406„Äë
- **Google Sheets**: read-only scope against `GOOGLE_SHEET_ID` (`bot_info` tab by default) with cached `get_all_values()`, manual column map (A‚ÄìAF), and Welcome templates pulled from `WelcomeTemplates` per call.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L64-L166„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2506-L2513„Äë

## WelcomeCrew (WC)
- **Entrypoint & runtime**: `_boot()` validates the Discord token, optionally launches the aiohttp health server, and runs a prefix `!` bot with custom help removed.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L80-L115„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1513-L1538„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1753-L1767„Äë
- **Commands**: admin/maintenance actions covering environment checks, sheet status, backfill, dedupe, reload, health, reboot, and watcher status; no built-in role checks are enforced (env toggles only).„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L237-L327„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1022-L1279„Äë
- **Listeners & threads**: auto-sync slash command, joins new threads, reacts to socket events, and runs live ticket watchers across Welcome/Promo channels with backfill/update handlers. Watchdog mirrors Matchmaker‚Äôs restart heuristics and a 3√ó/day clan-tag refresh loop.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L280-L359„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1398-L1471„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1540-L1593„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1644-L1752„Äë
- **Health surface**: same trio of `/`, `/ready`, `/health` plus `/healthz`, driven by `STRICT_PROBE`, with optional notify channel fallbacks for thread writes.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L71-L83„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1505-L1538„Äë
- **Guild channels & roles**: env-driven IDs for Welcome/Promo parents, notify channel/role, optional log channel, and toggles for watcher scopes; private-thread joins are gated by `ALLOW_SELF_JOIN_PRIVATE`.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L40-L83„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L632-L708„Äë
- **Google Sheets**: service-account writer that ensures headers on `Sheet1`/`Sheet4`, caches worksheet handles, throttles writes with retry/backoff, and periodically reloads the `clanlist` tag tab (column autodetect or configured index).„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L121-L156„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L306-L354„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L463-L520„Äë

## Top 10 Current Risks
1. **Blocking Sheets access in Matchmaker** ‚Äî `get_rows()` and friends call gspread synchronously on the gateway loop; heavy sheets or network stalls will freeze interactions.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L123-L144„Äë
2. **Blocking Sheets/tag reload in WelcomeCrew** ‚Äî `_load_clan_tags()` executes gspread reads inline from message handlers (via `_match_tag_in_text`), risking event-loop starvation during cache misses.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L306-L354„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L622-L708„Äë
3. **No permission gates on WelcomeCrew commands** ‚Äî every prefix command is callable by any member when enabled via env toggles, leaving destructive actions (e.g., `!reboot`, `!dedupe_sheet`) unguarded.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1022-L1279„Äë
4. **Hard-coded welcome log channel in Matchmaker** ‚Äî `LOG_CHANNEL_ID=1415330837968191629` is baked into source, making per-guild deployments brittle and leaking private IDs in logs.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2500-L2522„Äë
5. **Matchmaker welcome sheet fetch per command** ‚Äî `get_welcome_rows()` re-authorizes and pulls the entire template tab on each welcome action, adding latency and raising rate-limit exposure.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2506-L2513„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/welcome.py‚Ä†L303-L406„Äë
6. **`os._exit`/`sys.exit` restarts** ‚Äî both watchdogs and WelcomeCrew‚Äôs `!reboot` exit the interpreter abruptly, bypassing cleanup and leaving hosting platforms to restart the process.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2261-L2297„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1272-L1276„Äë
7. **Sheets write posture lacks per-call guardrails** ‚Äî WelcomeCrew batches writes but still runs `append_row`/`update` in worker threads without centralized quota awareness; concurrent backfills risk hitting API quotas despite retries.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L463-L520„Äë
8. **Shared watchdog heuristic duplication** ‚Äî identical zombie detection heuristics across bots increase the chance of systemic restarts if a platform issue trips both simultaneously.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2261-L2297„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1433-L1471„Äë
9. **Panel/thread cleanup requires privileged IDs** ‚Äî misconfigured `CLEANUP_THREAD_IDS` or recruiter thread IDs silently skip work; there is no alerting when fetches fail beyond stdout prints.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2140-L2156„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L660-L724„Äë
10. **Notify fallback depends on channel reachability** ‚Äî WelcomeCrew‚Äôs notify channel flow silently drops failures after logging to stdout; no escalation when fallback messaging cannot be delivered.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L632-L708„Äë

## Duplicate / Near-Duplicate Hotspots
- **Watchdog restart logic** ‚Äî `_watchdog` and `_maybe_restart` implementations are nearly identical between Matchmaker and WelcomeCrew, differing only in logging text.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2261-L2297„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1433-L1471„Äë
- **Health endpoint handlers** ‚Äî the aiohttp health routes share almost identical response bodies/`STRICT_PROBE` handling across both bots, duplicating maintenance burden.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2303-L2335„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1473-L1511„Äë
- **Socket event bookkeeping** ‚Äî both clients register the same `on_socket_response`/`on_connect`/`on_resumed` sequences to maintain heartbeat state, indicating a candidate for shared utility extraction.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2162-L2192„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1398-L1425„Äë

## Feature-Parity Merge Checklist (no new features)
1. **Unify shared infrastructure** ‚Äî extract watchdog + health server helpers into a shared module while preserving existing behavior toggles (`STRICT_PROBE`, restart thresholds).„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2261-L2335„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1433-L1511„Äë
2. **Normalize permission gating** ‚Äî decide on common role/perm requirements, wire them into WelcomeCrew commands, and ensure Matchmaker‚Äôs welcome Cog uses the shared policy.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L1100-L1148„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1022-L1279„Äë
3. **Abstract Sheets access layer** ‚Äî wrap gspread interactions with async-friendly helpers (to-thread + caching) shared by both bots to eliminate gateway blocking and align retry/backoff semantics.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L123-L166„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L306-L354„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L463-L520„Äë
4. **Parameterize guild-specific IDs** ‚Äî move hard-coded channel IDs (e.g., Matchmaker log channel) into environment variables and document them in a shared config schema.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2500-L2522„Äë
5. **Consolidate welcome templating** ‚Äî ensure both bots (and the Welcome Cog) consume the same cached welcome/tag data structures to prevent redundant sheet fetches and keep placeholders consistent.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/welcome.py‚Ä†L303-L406„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L306-L354„Äë
6. **Align health/telemetry reporting** ‚Äî adopt a shared payload schema for health endpoints and ensure both bots expose identical keys for monitors before merging services.„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/MM/bot_clanmatch_prefix.py‚Ä†L2306-L2335„Äë„ÄêF:AUDIT/legacy/clanmatch-welcomecrew/2025-10-10_code-export/WC/bot_welcomecrew.py‚Ä†L1473-L1511„Äë
7. **Regression checklist & smoke tests** ‚Äî script end-to-end validation covering recruiter panels, welcome posting, ticket logging, and sheet writes under the merged runtime to guarantee feature parity.

Doc last updated: 2025-10-10 (v0.9.5)
